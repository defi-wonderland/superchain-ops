// SPDX-License-Identifier: MIT
pragma solidity 0.8.15;

import {VmSafe} from "forge-std/Vm.sol";
import {stdToml} from "forge-std/StdToml.sol";
import {EnumerableSet} from "@openzeppelin/contracts/utils/structs/EnumerableSet.sol";

import {L2TaskBase} from "src/tasks/types/L2TaskBase.sol";
import {Action} from "src/libraries/MultisigTypes.sol";
import {MultisigTaskPrinter} from "src/libraries/MultisigTaskPrinter.sol";
import {RevShareCommon} from "src/libraries/RevShareCommon.sol";
import {Utils} from "src/libraries/Utils.sol";
import {SuperchainAddressRegistry} from "src/SuperchainAddressRegistry.sol";
import {IProxyAdmin} from "@eth-optimism-bedrock/interfaces/universal/IProxyAdmin.sol";
import {IOptimismPortal2} from "@eth-optimism-bedrock/interfaces/L1/IOptimismPortal2.sol";

/// @notice Task for updating Base's FeeDisburser to point OPTIMISM_WALLET to L1Withdrawer.
///         This deploys a new FeeDisburser implementation via CREATE2 and upgrades the proxy.
contract BaseFeeDisburserUpdate is L2TaskBase {
    using stdToml for string;
    using EnumerableSet for EnumerableSet.AddressSet;

    /// @notice FeeDisburser proxy address on L2
    address public feeDisburserProxy;

    /// @notice L1Withdrawer address already deployed on L2 (new OPTIMISM_WALLET)
    address public l1Withdrawer;

    /// @notice Current L1_WALLET to preserve
    address public l1Wallet;

    /// @notice Current FEE_DISBURSEMENT_INTERVAL to preserve
    uint256 public feeDisbursementInterval;

    /// @notice The gas limit for the FeeDisburser deployment.
    uint64 internal constant FEE_DISBURSER_DEPLOYMENT_GAS_LIMIT = 1_500_000;

    /// @notice The salt suffix for the FeeDisburser deployment.
    string internal constant FEE_DISBURSER_SALT_SUFFIX = "BaseFeeDisburser";

    /// @notice FeeDisburser creation bytecode.
    /// @dev    Source: lib/base-contracts/src/revenue-share/FeeDisburser.sol
    ///         Constructor args: (address payable _optimismWallet, address _l1Wallet, uint256 _feeDisbursementInterval)
    bytes public constant FEE_DISBURSER_CREATION_CODE =
        hex"60e06040523480156200001157600080fd5b50604051620017b6380380620017b68339818101604052810190620000379190620002c7565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603620000a9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620000a090620003aa565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036200011b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001129062000442565b60405180910390fd5b6201518081101562000164576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200015b9062000500565b60405180910390fd5b8273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff16815250508173ffffffffffffffffffffffffffffffffffffffff1660a08173ffffffffffffffffffffffffffffffffffffffff16815250508060c0818152505050505062000522565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200020f82620001e2565b9050919050565b620002218162000202565b81146200022d57600080fd5b50565b600081519050620002418162000216565b92915050565b60006200025482620001e2565b9050919050565b620002668162000247565b81146200027257600080fd5b50565b60008151905062000286816200025b565b92915050565b6000819050919050565b620002a1816200028c565b8114620002ad57600080fd5b50565b600081519050620002c18162000296565b92915050565b600080600060608486031215620002e357620002e2620001dd565b5b6000620002f38682870162000230565b9350506020620003068682870162000275565b92505060406200031986828701620002b0565b9150509250925092565b600082825260208201905092915050565b7f4665654469736275727365723a204f7074696d69736d57616c6c65742063616e60008201527f6e6f742062652061646472657373283029000000000000000000000000000000602082015250565b60006200039260318362000323565b91506200039f8262000334565b604082019050919050565b60006020820190508181036000830152620003c58162000383565b9050919050565b7f4665654469736275727365723a204c3157616c6c65742063616e6e6f7420626560008201527f2061646472657373283029000000000000000000000000000000000000000000602082015250565b60006200042a602b8362000323565b91506200043782620003cc565b604082019050919050565b600060208201905081810360008301526200045d816200041b565b9050919050565b7f4665654469736275727365723a2046656544697362757273656d656e74496e7460008201527f657276616c2063616e6e6f74206265206c657373207468616e20323420686f7560208201527f7273000000000000000000000000000000000000000000000000000000000000604082015250565b6000620004e860428362000323565b9150620004f58262000464565b606082019050919050565b600060208201905081810360008301526200051b81620004d9565b9050919050565b60805160a05160c05161124f6200056760003960008181610417015261044d0152600081816103e701526106550152600081816103be01526105be015261124f6000f3fe6080604052600436106100955760003560e01c806354664de51161005957806354664de5146102f95780635b201d831461032457806393819a3f1461034f578063ad41d09c1461037a578063b87ea8d4146103a55761021d565b80630c8cd07014610222578063235d506d1461024d57806336f1a6e514610278578063394d2731146102a3578063447eb5ac146102ce5761021d565b3661021d5773420000000000000000000000000000000000001173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610127575073420000000000000000000000000000000000001973ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b1561014a57346001600082825461013e9190610a96565b925050819055506101cd565b73420000000000000000000000000000000000001a73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101cc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101c390610b6f565b60405180910390fd5b5b3373ffffffffffffffffffffffffffffffffffffffff167f2ccfc58c2cef4ee590b5f16be0548cc54afc12e1c66a67b362b7d640fd16bb2d346040516102139190610b9e565b60405180910390a2005b600080fd5b34801561022e57600080fd5b506102376103bc565b6040516102449190610bfa565b60405180910390f35b34801561025957600080fd5b506102626103e0565b60405161026f9190610b9e565b60405180910390f35b34801561028457600080fd5b5061028d6103e5565b60405161029a9190610c36565b60405180910390f35b3480156102af57600080fd5b506102b8610409565b6040516102c59190610b9e565b60405180910390f35b3480156102da57600080fd5b506102e361040f565b6040516102f09190610b9e565b60405180910390f35b34801561030557600080fd5b5061030e610415565b60405161031b9190610b9e565b60405180910390f35b34801561033057600080fd5b50610339610439565b6040516103469190610c70565b60405180910390f35b34801561035b57600080fd5b5061036461043f565b6040516103719190610b9e565b60405180910390f35b34801561038657600080fd5b5061038f610445565b60405161039c9190610c70565b60405180910390f35b3480156103b157600080fd5b506103ba61044b565b005b7f000000000000000000000000000000000000000000000000000000000000000081565b60fa81565b7f000000000000000000000000000000000000000000000000000000000000000081565b60005481565b60015481565b7f000000000000000000000000000000000000000000000000000000000000000081565b61271081565b6105dc81565b6188b881565b7f00000000000000000000000000000000000000000000000000000000000000006000546104799190610a96565b4210156104bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104b290610cfd565b60405180910390fd5b6104d873420000000000000000000000000000000000001161071b565b6104f573420000000000000000000000000000000000001961071b565b61051273420000000000000000000000000000000000001a61071b565b600047905060008103610551577f8c887b1215d5e6b119c1c1008fe1d0919b4c438301d5a0357362a13fb56f6a4060405160405180910390a150610719565b42600081905550600061271063ffffffff166105dc6001546105739190610d1d565b61057d9190610da6565b90506000600181905550600061271063ffffffff1660fa8461059f9190610d1d565b6105a99190610da6565b905060006105b783836109cd565b90506105e37f0000000000000000000000000000000000000000000000000000000000000000826109e6565b610622576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161061990610e49565b60405180910390fd5b73420000000000000000000000000000000000001073ffffffffffffffffffffffffffffffffffffffff1663e11013dd477f00000000000000000000000000000000000000000000000000000000000000006188b8604051806020016040528060008152506040518563ffffffff1660e01b81526004016106a593929190610f02565b6000604051808303818588803b1580156106be57600080fd5b505af11580156106d2573d6000803e3d6000fd5b50505050507fe155e054cfe69655d6d2f8bbfb856aa8cdf49ecbea6557901533364539caad94600054828660405161070c93929190610f40565b60405180910390a1505050505b565b60018081111561072e5761072d610f77565b5b8173ffffffffffffffffffffffffffffffffffffffff1663d0e12f906040518163ffffffff1660e01b8152600401602060405180830381865afa158015610779573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061079d9190610fd0565b60018111156107af576107ae610f77565b5b146107ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107e69061106f565b60405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16630d9019e16040518163ffffffff1660e01b8152600401602060405180830381865afa158015610851573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061087591906110bb565b73ffffffffffffffffffffffffffffffffffffffff16146108cb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108c29061115a565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff1663d3e5792b6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610916573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061093a91906111a6565b8173ffffffffffffffffffffffffffffffffffffffff1631106109ca578073ffffffffffffffffffffffffffffffffffffffff16633ccfd60b6040518163ffffffff1660e01b81526004016020604051808303816000875af11580156109a4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109c891906111a6565b505b50565b60008183116109dc57816109de565b825b905092915050565b6000808373ffffffffffffffffffffffffffffffffffffffff1683604051610a0d90611204565b60006040518083038185875af1925050503d8060008114610a4a576040519150601f19603f3d011682016040523d82523d6000602084013e610a4f565b606091505b505090508091505092915050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610aa182610a5d565b9150610aac83610a5d565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610ae157610ae0610a67565b5b828201905092915050565b600082825260208201905092915050565b7f4665654469736275727365723a204f6e6c79204665655661756c74732063616e60008201527f2073656e642045544820746f2046656544697362757273657200000000000000602082015250565b6000610b59603983610aec565b9150610b6482610afd565b604082019050919050565b60006020820190508181036000830152610b8881610b4c565b9050919050565b610b9881610a5d565b82525050565b6000602082019050610bb36000830184610b8f565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610be482610bb9565b9050919050565b610bf481610bd9565b82525050565b6000602082019050610c0f6000830184610beb565b92915050565b6000610c2082610bb9565b9050919050565b610c3081610c15565b82525050565b6000602082019050610c4b6000830184610c27565b92915050565b600063ffffffff82169050919050565b610c6a81610c51565b82525050565b6000602082019050610c856000830184610c61565b92915050565b7f4665654469736275727365723a2044697362757273656d656e7420696e74657260008201527f76616c206e6f7420726561636865640000000000000000000000000000000000602082015250565b6000610ce7602f83610aec565b9150610cf282610c8b565b604082019050919050565b60006020820190508181036000830152610d1681610cda565b9050919050565b6000610d2882610a5d565b9150610d3383610a5d565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615610d6c57610d6b610a67565b5b828202905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610db182610a5d565b9150610dbc83610a5d565b925082610dcc57610dcb610d77565b5b828204905092915050565b7f4665654469736275727365723a204661696c656420746f2073656e642066756e60008201527f647320746f204f7074696d69736d000000000000000000000000000000000000602082015250565b6000610e33602e83610aec565b9150610e3e82610dd7565b604082019050919050565b60006020820190508181036000830152610e6281610e26565b9050919050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610ea3578082015181840152602081019050610e88565b83811115610eb2576000848401525b50505050565b6000601f19601f8301169050919050565b6000610ed482610e69565b610ede8185610e74565b9350610eee818560208601610e85565b610ef781610eb8565b840191505092915050565b6000606082019050610f176000830186610c27565b610f246020830185610c61565b8181036040830152610f368184610ec9565b9050949350505050565b6000606082019050610f556000830186610b8f565b610f626020830185610b8f565b610f6f6040830184610b8f565b949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b600080fd5b60028110610fb857600080fd5b50565b600081519050610fca81610fab565b92915050565b600060208284031215610fe657610fe5610fa6565b5b6000610ff484828501610fbb565b91505092915050565b7f4665654469736275727365723a204665655661756c74206d757374207769746860008201527f6472617720746f204c3200000000000000000000000000000000000000000000602082015250565b6000611059602a83610aec565b915061106482610ffd565b604082019050919050565b600060208201905081810360008301526110888161104c565b9050919050565b61109881610c15565b81146110a357600080fd5b50565b6000815190506110b58161108f565b92915050565b6000602082840312156110d1576110d0610fa6565b5b60006110df848285016110a6565b91505092915050565b7f4665654469736275727365723a204665655661756c74206d757374207769746860008201527f6472617720746f2046656544697362757273657220636f6e7472616374000000602082015250565b6000611144603d83610aec565b915061114f826110e8565b604082019050919050565b6000602082019050818103600083015261117381611137565b9050919050565b61118381610a5d565b811461118e57600080fd5b50565b6000815190506111a08161117a565b92915050565b6000602082840312156111bc576111bb610fa6565b5b60006111ca84828501611191565b91505092915050565b600081905092915050565b50565b60006111ee6000836111d3565b91506111f9826111de565b600082019050919050565b600061120f826111e1565b915081905091905056fea264697066735822122015a07fc89de0a7fbe0cb802513a64f2132dba5a498b31e4146a46383a630f43164736f6c634300080f0033";

    /// @notice Computed FeeDisburser implementation address (set in _build)
    address public feeDisburserImpl;

    /// @notice Default Safe name. Can be overridden via `safeAddressString` in config.toml.
    function safeAddressString() public pure override returns (string memory) {
        return "ProxyAdminOwner";
    }

    /// @notice Names in the SimpleAddressRegistry that are expected to be written during this task.
    function _taskStorageWrites() internal pure virtual override returns (string[] memory) {
        string[] memory writes = new string[](1);
        writes[0] = "OptimismPortalProxy";
        return writes;
    }

    /// @notice Returns an array of strings that refer to contract names in the address registry.
    function _taskBalanceChanges() internal view virtual override returns (string[] memory) {
        return new string[](0);
    }

    /// @notice Sets up the template with configurations from a TOML file.
    function _templateSetup(string memory taskConfigFilePath, address) internal override {
        string memory tomlContent = vm.readFile(taskConfigFilePath);

        // Load FeeDisburser configuration from TOML
        feeDisburserProxy = tomlContent.readAddress(".feeDisburserProxy");
        require(feeDisburserProxy != address(0), "FeeDisburser proxy address cannot be zero");

        l1Withdrawer = tomlContent.readAddress(".l1Withdrawer");
        require(l1Withdrawer != address(0), "L1Withdrawer address cannot be zero");

        l1Wallet = tomlContent.readAddress(".l1Wallet");
        require(l1Wallet != address(0), "L1Wallet address cannot be zero");

        feeDisbursementInterval = tomlContent.readUint(".feeDisbursementInterval");
        require(feeDisbursementInterval >= 24 hours, "Fee disbursement interval too short (must be >= 24 hours)");

        vm.label(feeDisburserProxy, "FeeDisburserProxy");
        vm.label(l1Withdrawer, "L1Withdrawer");
        vm.label(l1Wallet, "L1Wallet");
    }

    /// @notice Builds the actions for executing the operations.
    ///         Transaction 1: Deploy new FeeDisburser implementation via CREATE2
    ///         Transaction 2: Upgrade the FeeDisburser proxy to the new implementation
    function _build(address) internal override {
        SuperchainAddressRegistry.ChainInfo[] memory chains = superchainAddrRegistry.getChains();

        for (uint256 i = 0; i < chains.length; i++) {
            address portal = superchainAddrRegistry.getAddress("OptimismPortalProxy", chains[i].chainId);

            // Build FeeDisburser init code with constructor args:
            // (address payable _optimismWallet, address _l1Wallet, uint256 _feeDisbursementInterval)
            // Note: _optimismWallet is now the L1Withdrawer address
            bytes memory initCode =
                abi.encodePacked(FEE_DISBURSER_CREATION_CODE, abi.encode(l1Withdrawer, l1Wallet, feeDisbursementInterval));

            // Compute the CREATE2 address for the new implementation
            bytes32 salt = RevShareCommon.getSalt(FEE_DISBURSER_SALT_SUFFIX);
            feeDisburserImpl = Utils.getCreate2Address(salt, initCode, RevShareCommon.CREATE2_DEPLOYER);

            // Transaction 1: Deploy new FeeDisburser implementation via CREATE2
            RevShareCommon.depositCreate2(portal, FEE_DISBURSER_DEPLOYMENT_GAS_LIMIT, salt, initCode);

            // Transaction 2: Upgrade the proxy to the new implementation
            RevShareCommon.depositCall(
                portal,
                RevShareCommon.PROXY_ADMIN,
                RevShareCommon.UPGRADE_GAS_LIMIT,
                abi.encodeCall(IProxyAdmin.upgrade, (payable(feeDisburserProxy), feeDisburserImpl))
            );
        }
    }

    /// @notice This method performs all validations and assertions that verify the calls executed as expected.
    function _validate(VmSafe.AccountAccess[] memory, Action[] memory _actions, address) internal view override {
        MultisigTaskPrinter.printTitle("Validating BaseFeeDisburserUpdate deposit transactions");

        SuperchainAddressRegistry.ChainInfo[] memory chains = superchainAddrRegistry.getChains();

        // Expected: 2 actions per chain (CREATE2 deploy + proxy upgrade)
        uint256 expectedActions = chains.length * 2;
        require(_actions.length == expectedActions, "Expected 2 actions per chain (deploy + upgrade)");

        // Build the expected init code and compute expected implementation address
        bytes memory initCode =
            abi.encodePacked(FEE_DISBURSER_CREATION_CODE, abi.encode(l1Withdrawer, l1Wallet, feeDisbursementInterval));
        bytes32 salt = RevShareCommon.getSalt(FEE_DISBURSER_SALT_SUFFIX);
        address expectedImpl = Utils.getCreate2Address(salt, initCode, RevShareCommon.CREATE2_DEPLOYER);

        for (uint256 i = 0; i < chains.length; i++) {
            address portal = superchainAddrRegistry.getAddress("OptimismPortalProxy", chains[i].chainId);

            // Action index: 2 actions per chain
            uint256 deployActionIdx = i * 2;
            uint256 upgradeActionIdx = i * 2 + 1;

            // Validate deploy action (CREATE2)
            Action memory deployAction = _actions[deployActionIdx];
            require(deployAction.target == portal, "Deploy action target must be portal");
            require(deployAction.value == 0, "Deploy action value must be 0");

            // Verify deposit transaction signature
            bytes4 deploySelector = bytes4(deployAction.arguments);
            require(
                deploySelector == IOptimismPortal2.depositTransaction.selector,
                "Deploy action must call depositTransaction"
            );

            // Validate upgrade action
            Action memory upgradeAction = _actions[upgradeActionIdx];
            require(upgradeAction.target == portal, "Upgrade action target must be portal");
            require(upgradeAction.value == 0, "Upgrade action value must be 0");

            // Verify deposit transaction signature
            bytes4 upgradeSelector = bytes4(upgradeAction.arguments);
            require(
                upgradeSelector == IOptimismPortal2.depositTransaction.selector,
                "Upgrade action must call depositTransaction"
            );

            // Build expected upgrade calldata
            bytes memory expectedUpgradeData =
                abi.encodeCall(IProxyAdmin.upgrade, (payable(feeDisburserProxy), expectedImpl));
            bytes memory expectedUpgradeDepositArgs = abi.encodeCall(
                IOptimismPortal2.depositTransaction,
                (RevShareCommon.PROXY_ADMIN, 0, RevShareCommon.UPGRADE_GAS_LIMIT, false, expectedUpgradeData)
            );

            require(
                keccak256(upgradeAction.arguments) == keccak256(expectedUpgradeDepositArgs),
                "Upgrade action arguments mismatch"
            );
        }

        // Log validation success
        MultisigTaskPrinter.printTitle("Validation complete");
    }

    /// @notice Override to return a list of addresses that should not be checked for code length.
    function _getCodeExceptions() internal view virtual override returns (address[] memory) {
        return new address[](0);
    }
}
